<html>
	<head>
		<title>Chat</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=0.8">
		
		<link href="https://fonts.googleapis.com/css?family=Vollkorn" rel="stylesheet">
		<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"/>
		<link rel="stylesheet" type="text/css" href="/index.css">
		
		<script src="/index.js"></script>
	</head>
	<body>
		<!--
		
		Set to display:table; to show this loading screen.
		
		-->
		<div style="z-index:1;background-color:white;display:none;position:absolute;height:100%;width:100%;overflow:hidden;">
			<div style="display:table-cell;vertical-align:middle;">
				<div style="margin-left:auto;margin-right:auto;width:100%;text-align:center;">
					<svg style="width:80;height:80;">
						<rect x="0" y="0" height="16" width="16" style="fill:crimson;">
							<animate id="box1a1" attributeName="x"
								from="0"  to="60"
								begin="0s; box1a2.end" dur="1s"
								fill="freeze"/>
							<animate id="box1a2" attributeName="y"
								from="0"  to="60"
								begin="box1a1.end" dur="750ms"
								fill="remove"/>
						</rect>
						<rect x="60" y="60" height="16" width="16" style="fill:crimson;">
							<animate id="box2a1" attributeName="x"
								from="60"  to="0"
								begin="0s; box2a2.end" dur="1s"
								fill="freeze"/>
							<animate id="box2a2" attributeName="y"
								from="60"  to="0"
								begin="box2a1.end;" dur="750ms"
								fill="remove"/>
						</rect>
					</svg>
				</div>
			</div>
		</div>
		
		
		<table id="banner"><tr><td>
			<div id="bannerleft">
				<div id="icon"><img src="/favicon.ico"/></div>
				<div id="status">Welcome.</div>
			</div></td><td style="display:table-cell;vertical-align:middle;">
			<div id="bannerright">
				<div id="links">
					<a class="bannerLink" href="/cms/">Manage</a>&nbsp&nbsp|&nbsp
					<a class="bannerLink" href="/chat/">Chat</a>&nbsp&nbsp
				</div>
			</div></td></tr>
		</table>
		<div id="contentborder">
			<div id="content">
				
<h2>Chat</h2>
<table style="height:auto;width:100%;">
<tr><td id="handleOrUsername">
User:&nbsp
<input id="handleField" autocomplete="on" type="text" size="10" placeholder="handle">
</td></tr>
<tr><td>
<br>
<!--
<input id="submitButton" type="button" value="Send">
-->
<input id="messageField" type="text" style="width:100%;" placeholder="enter to send message">
</td></tr>
<tr><td style="height:100%;vertical-align:top;">
<hr>
<div id="messages"></div>
</td></tr></table>
<script>
	sub_scripts.push(function(){
		var status = document.getElementById("status");
		var handleField = document.getElementById("handleField");
		var messageField = document.getElementById("messageField");
		var submitButton = document.getElementById("submitButton");
		var messages = document.getElementById("messages");
		
		var ding = new Audio('/chat/ding.mp3');
		
		if(localStorage.getItem(localStorageTokenKey) !== null){
			callAPI("POST", "/token", {"token": localStorage.getItem(localStorageTokenKey)}, function(response){
				if(typeof(response.error) !== 'undefined'){
					localStorage.removeItem(localStorageUsernameKey);
					localStorage.removeItem(localStorageTokenKey);
			
					window.location.reload();
				}
			});
		}

		var session_token = null;
		if(localStorage.getItem(localStorageTokenKey) !== null){
			session_token = localStorage.getItem(localStorageTokenKey);
		}
		
		if(localStorage.getItem(localStorageUsernameKey) !== null){
			document.getElementById("handleOrUsername").innerHTML = "Using login handle: " + localStorage.getItem(localStorageUsernameKey);
			handleField.value = localStorage.getItem(localStorageUsernameKey);
			messageField.focus();
		}else if(localStorage.getItem("JPH2_CHAT_HANDLE") !== null){
			handleField.value = localStorage.getItem("JPH2_CHAT_HANDLE");
			messageField.focus();
		}else{
			handleField.focus();
		}
		
		handleField.onclick = function(){
			handleField.value = "";
		};
		
		function get_colored_star(color){
			return '<svg width="16px" height="16px" viewBox="0 0 51 48"><path fill="' + color + '" stroke="black" d="m25,1 6,17h18l-14,11 5,17-15-10-15,10 5-17-14-11h18z"/></svg>&nbsp';
		}

		var ws;
		var ws_is_done_for_session = false;
		var msg = {};
		var star = 0;

		function connected(e){
			//console.log(e);
			status.innerHTML = "Connected.";
			ws.send("\"get_messages\"");
		}

		function receive(e){
			if(e.data == "pong"){
				//console.log("good ping " + ws.readyState);
				return;
			}
			//console.log("RECV:" + e.data);
			msg = JSON.parse(e.data);
			if(typeof msg.messages !== 'undefined'){
				var newhtml = "";
				for(var i = 0, len = msg.messages.length; i < len; i++){
					//console.log(msg.messages[i]);
					if(typeof msg.messages[i].color !== "undefined"){
						//console.log(get_colored_star(msg.messages[i].color));
						newhtml += "<p>" + get_colored_star(msg.messages[i].color) + msg.messages[i].handle + ": " + msg.messages[i].message + "</p>";
					}else{
						newhtml += "<p>" + msg.messages[i].handle + ": " + msg.messages[i].message + "</p>";
					}
				}
				messages.innerHTML = newhtml;
			}else if(typeof msg.handle !== 'undefined' && typeof msg.message !== 'undefined'){
				//msg.message = msg.message.replace(/ /g, '\u00a0');
				//console.log(msg.message);
				if(msg.handle != handleField.value){
					ding.play();
				}
				if(typeof msg.color !== 'undefined'){
					messages.innerHTML = "<p>" + get_colored_star(msg.color) + msg.handle + ": " + msg.message + "</p>" + messages.innerHTML;
				}else{
					messages.innerHTML = "<p>" + msg.handle + ": " + msg.message + "</p>" + messages.innerHTML;
				}
			}else if(typeof msg.status !== 'undefined'){
				if(msg.status.startsWith("Bad login token.")){
				//	window.location.reload();
					ws_is_done_for_session = true;
				}else if(msg.status.startsWith("That's an existing username.")){
					handleField.value = "";
					handleField.focus();
				}
				status.innerHTML = msg.status;
			}else{
				console.log("Received junk?");
			}
			
		}

		function closed(e){
			//console.log(e);
			status.innerHTML = "Disconnected.";
		}

		function errored(e){
			//console.log(e);
			status.innerHTML = "Error.";
		}

		function setupWebsocket(){
			ws = new WebSocket("wss://" + window.location.hostname + ":8000/");
			ws.onopen = connected;
			ws.onmessage = receive;
			ws.onclose = closed;
			ws.onerror = errored;
		}

		setupWebsocket();

		function ping(){
			if(ws_is_done_for_session){
				return;
			}

			//console.log("ping " + ws.readyState);
	
			// 0 - Connecting
			// 1 - Open
			// 2 - Closing
			// 3 - Closed
			if(ws.readyState === ws.CLOSED){
				setupWebsocket();
				status.innerHTML = "Connecting...";
			}else if(ws.readyState === ws.OPEN){
				status.innerHTML = "Connected.";
				ws.send("ping");
			}else{
				status.innerHTML = "Working...";
			}
		}
		var pinger = setInterval(ping, 1000);

		function send(e){
			status.innerHTML = "";
			clearInterval(pinger);
			pinger = setInterval(ping, 1000);
			msg = {};
			if(session_token !== null){
				msg.token = session_token;
			}else{
				msg.handle = handleField.value;
			}
			msg.message = messageField.value;
			messageField.value = "";
			messageField.focus();

			//console.log("SEND:" + JSON.stringify(msg));
			ws.send(JSON.stringify(msg));
			localStorage.setItem("JPH2_CHAT_HANDLE", handleField.value);
		}

		window.onkeypress = function(e){
			if(e.code === "Enter"){
				send(e);
			}else{
				//console.log(e.code);
			}
		}

		//submitButton.onclick = send;
	});
</script>


			</div>
		</div>
	</body>
	<script>
		sub_scripts.push(function(){
			var icon = document.getElementById("icon");
			icon.onclick = function(){
				window.location = "/index.html";
			};
		});
	</script>
</html>
