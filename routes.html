<html>
	<head>
		<title>API</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=0.6">
		
		<link href="https://fonts.googleapis.com/css?family=Vollkorn" rel="stylesheet">
		<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"/>
		<link rel="stylesheet" type="text/css" href="/index.css">
		
		<script src="/websocket.js"></script>
		<script src="/index.js"></script>
	</head>
	<body>
		<!--
		
		Set to display:table; to show this loading screen.
		
		<div style="z-index:1;background-color:white;display:none;position:absolute;height:100%;width:100%;overflow:hidden;">
			<div style="display:table-cell;vertical-align:middle;">
				<div style="margin-left:auto;margin-right:auto;width:100%;text-align:center;">
					<svg style="width:80;height:80;">
						<rect x="0" y="0" height="16" width="16" style="fill:crimson;">
							<animate id="box1a1" attributeName="x"
								from="0"  to="60"
								begin="0s; box1a2.end" dur="1s"
								fill="freeze"/>
							<animate id="box1a2" attributeName="y"
								from="0"  to="60"
								begin="box1a1.end" dur="750ms"
								fill="remove"/>
						</rect>
						<rect x="60" y="60" height="16" width="16" style="fill:crimson;">
							<animate id="box2a1" attributeName="x"
								from="60"  to="0"
								begin="0s; box2a2.end" dur="1s"
								fill="freeze"/>
							<animate id="box2a2" attributeName="y"
								from="60"  to="0"
								begin="box2a1.end;" dur="750ms"
								fill="remove"/>
						</rect>
					</svg>
				</div>
			</div>
		</div>
		
		-->
		
		<table id="banner">
			<tr><td><div id="bannerleft">
				<div id="icon"><img src="/favicon.ico"/></div>
				<div id="status">Welcome.</div>
			</div></td>
			
			<td style="display:table-cell;vertical-align:middle;"><div id="bannerright">
				<div id="links">
					<a class="bannerLink" href="/cms/">Manage</a>&nbsp&nbsp|&nbsp
					<a class="bannerLink" href="/poi/?username=bwackwat">Points of Interest</a>&nbsp&nbsp|&nbsp
					<a class="bannerLink" href="/chat/">Chat</a>&nbsp&nbsp
				</div>
			</div></td></tr>
		</table>
		
		<div id="contentborder">
			<div id="content">
				
<h2>API Testing</h2>
<h4>If you are logged in, your login token will automatically be included in the submitted data.</h4>

<hr>

<div id="selectRoute" style="display:none;">
	<h3>Select a route:</h3>
	<div id="routeRadios">
	</div>
</div>

<div id="requestRoute" style="display:none;">
	<input id="selectAnotherRoute" type="button" value="Select Another Route"/>
	<h3 id="selectedRoute"></h3>
	<h4 id="routeRateLimit"></h4>
	<h4 id="routeParameters"></h4>
	<label for="routeData">Raw JSON Formatted Data (all string values):</label>
	<br>
	<textarea id="routeData" cols="80" rows="8"></textarea>
	<br>
	<br>
	<input id="submitRoute" type="button" value="Submit"/>
	<div id="routeResponse">
		<h3>Response: </h3>
		<pre id="routeResponseData"></pre>
	</div>
</div>

<script>
	var status = document.getElementById("status");
	var selectRoute = document.getElementById("selectRoute");
	var routeRadios = document.getElementById("routeRadios");
	
	var requestRoute = document.getElementById("requestRoute");
	var selectAnotherRoute = document.getElementById("selectAnotherRoute");
	var selectedRoute = document.getElementById("selectedRoute");
	var routeRateLimit = document.getElementById("routeRateLimit");
	var routeParameters = document.getElementById("routeParameters");
	var routeData = document.getElementById("routeData");
	var submitRoute = document.getElementById("submitRoute");
	var routeResponse = document.getElementById("routeResponse");
	
	var selectedRouteKey;
	var routes = {};
	
	function routeSelected(route){
		selectRoute.style.display = "none";
		
		selectedRouteKey = route;
		
		selectedRoute.innerHTML = "Selected Route: " + route;
		routeRateLimit.innerHTML = "Rate Limit: " + routes[route].rate_limit + "ms";
		if(routes[route].parameters.length === 0){
			routeParameters.innerHTML = "Required Parameters: None"	;
		}else{
			routeParameters.innerHTML = "Required Parameters: " + routes[route].parameters;
		}
		routeData.innerHTML = "";
		
		console.log(routes[route]);
		
		requestRoute.style.display = "block";
		routeResponse.style.display = "none";
	}
	
	function selectNewRoute(){
		selectRoute.style.display = "block";
		requestRoute.style.display = "none";
		routeResponse.style.display = "none";
	}
	selectNewRoute();
	selectAnotherRoute.onclick = selectNewRoute;
	
	submitRoute.onclick = function(){
		var status = document.getElementById("status");
		var data;
		try{
			if(routeData.value.trim() === ""){
				data = {};
			}else{
				data = JSON.parse(routeData.value);
			}
		}catch(e){
			status.innerHTML = "Bad JSON.";
			console.log(e);
			return;
		}
		
		var useToken = false;
		for(param in routes[selectedRouteKey].parameters){
			if(routes[selectedRouteKey].parameters[param] === "token"){
				console.log("USE TOKEN");
				useToken = true;
				break;
			}
		}
		if(useToken){
			if(localStorage.getItem(localStorageTokenKey) !== null &&
			localStorage.getItem(localStorageTokenKey) !== "undefined"){
				data["token"] = localStorage.getItem(localStorageTokenKey);
			}else{
				status.innerHTML = "This route requires you to be logged in.";
				return;
			}
		}
		
		var splitRoute = selectedRouteKey.split(' ');
		
		callAPI(splitRoute[0], splitRoute[1].substr(4), data, function(response){
			if(typeof(response.error) === 'undefined'){
				routeResponse.style.display = "block";
				routeResponseData.innerHTML = JSON.stringify(response, null, 5);
			}else{
				status.innerHTML = response.error;
			}
		});
	};
	
	function api_routing_subscript(){
		callAPI("GET", "/routes", {}, function(response){
			if(typeof(response.error) === 'undefined'){
				Object.keys(response).sort().reverse().forEach(function(route) {
					routes[route] = response[route];
				});
			
				var new_html = "";
				for(var route in routes){
					new_html += "<input type='radio' name='routes' value='" + route + "' onclick='routeSelected(\"" + route + "\");'>" + route + "<br>";
				}
				routeRadios.innerHTML = new_html;
			}else{
				status.innerHTML = response.error;
			}
		});
	}
	
	sub_scripts.push(api_routing_subscript);
</script>

			</div>
		</div>
	</body>
	<script>
		sub_scripts.push(function(){
			var icon = document.getElementById("icon");
			icon.onclick = function(){
				window.location = "/index.html";
			};
		});
	</script>
</html>
